services:
  mentor-site:
    build:
      context: .
      args:
        BASE_PATH: ${BASE_PATH:-/mentor-site}
    container_name: mentor-site-prod
    ports:
      # Map host port 3000 to container port 80 (nginx)
      - "3000:80"
    environment:
      - NODE_ENV=production
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY:-}
      - STRIPE_PUBLISHABLE_KEY=${STRIPE_PUBLISHABLE_KEY:-}
      - STRIPE_PRICE_ID=${STRIPE_PRICE_ID:-}
      - STRIPE_PAYMENT_LINK=${STRIPE_PAYMENT_LINK:-}
      - STRIPE_SUCCESS_URL=${STRIPE_SUCCESS_URL:-}
      - STRIPE_CANCEL_URL=${STRIPE_CANCEL_URL:-}
      - STRIPE_ENDPOINT_SECRET=${STRIPE_ENDPOINT_SECRET:-}
      - SITE_CALENDLY_LINK=${SITE_CALENDLY_LINK:-https://calendly.com/toucan-sg/consulting-link}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  authoring-tool:
    build:
      context: .
      dockerfile: Dockerfile.dev
      args:
        BASE_PATH: ${BASE_PATH:-/mentor-site}
    container_name: mentor-site-authoring
    command: python author_app.py
    ports:
      - "5001:5000"
    volumes:
      - ./content:/app/content
    environment:
      - AUTHORING_CONTENT_DIR=/app/content/posts
      - AUTHORING_SECRET_KEY=authoring-dev-secret
      - BASE_PATH=${BASE_PATH:-/mentor-site}
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY:-}
      - STRIPE_ENDPOINT_SECRET=${STRIPE_ENDPOINT_SECRET:-}
    restart: unless-stopped
    profiles:
      - authoring

  # Alternative service for development
  mentor-site-dev:
    build:
      context: .
      dockerfile: Dockerfile.dev
      args:
        BASE_PATH: ${BASE_PATH:-/mentor-site}
    container_name: mentor-site-dev
    ports:
      - "5000:5000"  # Map host 5000 to Flask dev server
    command: python app.py
    environment:
      - FLASK_ENV=development
      - FLASK_DEBUG=1
      - BASE_PATH=${BASE_PATH:-/}
      - SITE_CALENDLY_LINK=${SITE_CALENDLY_LINK:-https://calendly.com/toucan-sg/consulting-link}
    volumes:
      - ./:/app
    env_file:
      - .env.dev
    profiles:
      - dev  # Only start with --profile dev
    restart: "no"
    develop:
      watch:
        - action: sync
          path: .
          target: /app
          ignore:
            - .git
            - __pycache__
            - node_modules
        - action: rebuild
          path: .env.dev

  tests:
    build:
      context: .
      dockerfile: Dockerfile.dev
      args:
        BASE_PATH: ${BASE_PATH:-/mentor-site}
    command: pytest
    volumes:
      - ./:/app
    profiles:
      - ci
    working_dir: /app
    environment:
      - PYTHONDONTWRITEBYTECODE=1
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY:-}
      - STRIPE_ENDPOINT_SECRET=${STRIPE_ENDPOINT_SECRET:-}
    restart: "no"

networks:
  default:
    name: mentor-site-network
