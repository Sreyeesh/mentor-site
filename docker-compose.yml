services:
  mentor-site:
    build:
      context: .
      args:
        BASE_PATH: ${BASE_PATH:-/mentor-site}
    container_name: mentor-site-prod
    ports:
      # Map host port 3000 to container port 80 (nginx)
      - "3000:80"
    environment:
      - NODE_ENV=production
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  authoring-tool:
    build:
      context: .
      dockerfile: Dockerfile.dev
      args:
        BASE_PATH: ${BASE_PATH:-/mentor-site}
    container_name: mentor-site-authoring
    command: python author_app.py
    ports:
      - "5001:5000"
    volumes:
      - ./content:/app/content
    environment:
      - AUTHORING_CONTENT_DIR=/app/content/posts
      - AUTHORING_SECRET_KEY=authoring-dev-secret
      - BASE_PATH=${BASE_PATH:-/mentor-site}
    restart: unless-stopped
    profiles:
      - authoring

  # Alternative service for development
  mentor-site-dev:
    build:
      context: .
      dockerfile: Dockerfile.dev
      args:
        BASE_PATH: ${BASE_PATH:-/mentor-site}
    container_name: mentor-site-dev
    ports:
      - "5000:5000"  # Map host 5000 to Flask dev server
    command: python app.py
    environment:
      - FLASK_ENV=development
      - FLASK_DEBUG=1
      - BASE_PATH=${BASE_PATH:-/}
    volumes:
      - ./:/app
    profiles:
      - dev  # Only start with --profile dev
    restart: "no"
    develop:
      watch:
        - action: sync
          path: .
          target: /app
          ignore:
            - .git
            - __pycache__
            - node_modules

  tests:
    build:
      context: .
      dockerfile: Dockerfile.dev
      args:
        BASE_PATH: ${BASE_PATH:-/mentor-site}
    command: pytest
    volumes:
      - ./:/app
    profiles:
      - ci
    working_dir: /app
    environment:
      - PYTHONDONTWRITEBYTECODE=1
    restart: "no"

networks:
  default:
    name: mentor-site-network
