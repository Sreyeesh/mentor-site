{% extends 'blog/base.html' %}

{% set giscus = config.giscus if config.giscus is defined else {} %}

{% block title %}{{ post.title }} — {{ config.name }} Blog{% endblock %}
{% block meta_description %}{{ post.description or post.excerpt }}{% endblock %}

{% block head_extra %}
    <link rel="canonical" href="{{ canonical_url }}">
{% endblock %}

{% block content %}
<article class="blog-post">
    <header class="blog-post-header">
        <p class="blog-post-date">{{ post.date_display }} • {{ post.reading_time }} min read</p>
        <h1>{{ post.title }}</h1>
    </header>

    {% if post.hero_image %}
        <figure class="blog-post-hero">
            <img src="{{ url_for('static', filename=post.hero_image) }}" alt="" loading="lazy">
        </figure>
    {% endif %}

    <div class="blog-post-body">
        {{ post.content | safe }}
    </div>

    <footer class="blog-post-footer">
        <div class="blog-share">
            <span>Share:</span>
            <a href="https://twitter.com/intent/tweet?text={{ post.title | urlencode }}&url={{ canonical_url | urlencode }}" target="_blank" rel="noreferrer noopener">X (Twitter)</a>
            <a href="https://www.linkedin.com/sharing/share-offsite/?url={{ canonical_url | urlencode }}" target="_blank" rel="noreferrer noopener">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path>
                    <rect x="2" y="9" width="4" height="12"></rect>
                    <circle cx="4" cy="4" r="2"></circle>
                </svg>
                LinkedIn
            </a>
        </div>
        <a class="back-to-blog" href="{{ blog_index_href }}">← Back to all posts</a>
    </footer>
</article>

<section class="blog-comments" aria-labelledby="comments-title">
    <h2 id="comments-title">Join the discussion</h2>
    {% if giscus.enabled %}
        {% set giscus_payload = {
            'repo': giscus.repo,
            'repo_id': giscus.repo_id,
            'category': giscus.category,
            'category_id': giscus.category_id,
            'mapping': giscus.mapping,
            'strict': giscus.strict,
            'reactions_enabled': giscus.reactions_enabled,
            'emit_metadata': giscus.emit_metadata,
            'input_position': giscus.input_position,
            'lang': giscus.lang,
            'theme_light': giscus.theme_light,
            'theme_dark': giscus.theme_dark,
            'loading': giscus.loading
        } %}
        <div class="giscus" data-enabled="true"></div>
        <script>
            (function () {
                const config = {{ giscus_payload | tojson }};
                const requiredKeys = ['repo', 'repo_id', 'category', 'category_id'];
                if (!requiredKeys.every((key) => config[key])) {
                    return;
                }

                function preferredTheme() {
                    try {
                        const storedTheme = localStorage.getItem('theme');
                        if (storedTheme === 'dark' || storedTheme === 'light') {
                            return storedTheme;
                        }
                        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                            return 'dark';
                        }
                    } catch (error) {
                        console.warn('Unable to determine preferred theme for Giscus:', error);
                    }
                    return 'light';
                }

                const script = document.createElement('script');
                script.id = 'giscus-script';
                script.src = 'https://giscus.app/client.js';
                script.async = true;
                script.setAttribute('data-repo', config.repo);
                script.setAttribute('data-repo-id', config.repo_id);
                script.setAttribute('data-category', config.category);
                script.setAttribute('data-category-id', config.category_id);
                script.setAttribute('data-mapping', config.mapping || 'pathname');
                script.setAttribute('data-strict', config.strict || '1');
                script.setAttribute('data-reactions-enabled', config.reactions_enabled || '1');
                script.setAttribute('data-emit-metadata', config.emit_metadata || '0');
                script.setAttribute('data-input-position', config.input_position || 'bottom');
                script.setAttribute('data-lang', config.lang || 'en');
                script.setAttribute('data-loading', config.loading || 'lazy');
                script.setAttribute(
                    'data-theme',
                    preferredTheme() === 'dark' ? config.theme_dark : config.theme_light
                );
                script.setAttribute('crossorigin', 'anonymous');

                const container = document.querySelector('.giscus');
                if (!container) {
                    return;
                }
                container.innerHTML = '';
                container.appendChild(script);
            })();
        </script>
        <noscript class="giscus-noscript">Enable JavaScript to view comments powered by Giscus.</noscript>
    {% else %}
        <p class="giscus-placeholder">Comments are coming soon — check back shortly.</p>
    {% endif %}
</section>

<aside class="blog-related">
    <h2>More to explore</h2>
    <ul>
        {% set related = (posts | selectattr('slug', 'ne', post.slug) | list)[:3] %}
        {% if related %}
            {% for other in related %}
                <li>
                    <a href="{{ blog_index_href }}{{ other.slug }}/">
                        <span class="related-title">{{ other.title }}</span>
                        <span class="related-meta">{{ other.date_display }} • {{ other.reading_time }} min read</span>
                    </a>
                </li>
            {% endfor %}
        {% else %}
            <li>No other posts yet.</li>
        {% endif %}
    </ul>
</aside>
{% endblock %}

{% block scripts %}
    {% if giscus.enabled %}
        <script>
            (function () {
                const DARK_THEME = '{{ giscus.theme_dark }}';
                const LIGHT_THEME = '{{ giscus.theme_light }}';

                function currentTheme() {
                    const storedTheme = localStorage.getItem('theme');
                    if (storedTheme) {
                        return storedTheme;
                    }
                    return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
                }

                function resolveGiscusTheme(nextTheme) {
                    return nextTheme === 'dark' ? DARK_THEME : LIGHT_THEME;
                }

                function updateGiscusTheme(nextTheme) {
                    const iframe = document.querySelector('iframe.giscus-frame');
                    if (!iframe) {
                        return;
                    }
                    iframe.contentWindow.postMessage({
                        giscus: {
                            setConfig: {
                                theme: resolveGiscusTheme(nextTheme)
                            }
                        }
                    }, 'https://giscus.app');
                }

                document.addEventListener('themechange', function (event) {
                    updateGiscusTheme(event.detail);
                });

                document.addEventListener('DOMContentLoaded', function () {
                    const initialTheme = currentTheme();

                    const observer = new MutationObserver(function () {
                        const iframe = document.querySelector('iframe.giscus-frame');
                        if (iframe) {
                            updateGiscusTheme(initialTheme);
                            observer.disconnect();
                        }
                    });
                    observer.observe(document.body, { childList: true, subtree: true });
                });
            })();
        </script>
    {% endif %}
{% endblock %}
