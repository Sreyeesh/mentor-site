{% extends 'blog/base.html' %}

{% set giscus = config.giscus if config.giscus is defined else {} %}

{% block title %}{{ post.title }} — {{ config.name }} Blog{% endblock %}
{% block meta_description %}{{ post.description or post.excerpt }}{% endblock %}

{% block head_extra %}
    <link rel="canonical" href="{{ canonical_url }}">
    {% set social_description = (post.description or post.excerpt) %}
    {% set hero_path = post.hero_image and url_for('static', filename=post.hero_image) %}
    {% if hero_path %}
        {% if config.site_url %}
            {% set social_image = config.site_url ~ hero_path %}
        {% else %}
            {% set social_image = hero_path %}
        {% endif %}
    {% else %}
        {% set default_image_path = url_for('static', filename='images/SreyeeshProfilePic.jpg') %}
        {% if config.site_url %}
            {% set social_image = config.site_url ~ default_image_path %}
        {% else %}
            {% set social_image = default_image_path %}
        {% endif %}
    {% endif %}

    <meta property="og:type" content="article">
    <meta property="og:site_name" content="{{ config.name }}">
    <meta property="og:title" content="{{ post.title }}">
    {% if social_description %}
        <meta property="og:description" content="{{ social_description }}">
    {% endif %}
    <meta property="og:url" content="{{ canonical_url }}">
    {% if social_image %}
        <meta property="og:image" content="{{ social_image }}">
    {% endif %}

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{{ post.title }}">
    {% if social_description %}
        <meta name="twitter:description" content="{{ social_description }}">
    {% endif %}
    {% if social_image %}
        <meta name="twitter:image" content="{{ social_image }}">
    {% endif %}
{% endblock %}

{% block content %}
<article class="blog-post">
    <header class="blog-post-header">
        <p class="blog-post-date">{{ post.date_display }} • {{ post.reading_time }} min read</p>
        <h1>{{ post.title }}</h1>
    </header>

    {% if post.hero_image %}
        <figure class="blog-post-hero">
            <img src="{{ url_for('static', filename=post.hero_image) }}" alt="" loading="lazy">
        </figure>
    {% endif %}

    <div class="blog-post-body">
        {{ post.content | safe }}
    </div>

    <footer class="blog-post-footer">
        <div class="blog-share">
            <span>Share:</span>
            <a href="https://twitter.com/intent/tweet?text={{ post.title | urlencode }}&url={{ canonical_url | urlencode }}" target="_blank" rel="noreferrer noopener">X (Twitter)</a>
            <a href="https://www.linkedin.com/sharing/share-offsite/?url={{ canonical_url | urlencode }}" target="_blank" rel="noreferrer noopener">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path>
                    <rect x="2" y="9" width="4" height="12"></rect>
                    <circle cx="4" cy="4" r="2"></circle>
                </svg>
                LinkedIn
            </a>
        </div>
        <a class="back-to-blog" href="{{ blog_index_href }}">← Back to all posts</a>
    </footer>
</article>

<section class="blog-comments" aria-labelledby="comments-title">
    <h2 id="comments-title">Join the discussion</h2>
    {% if giscus.repo and giscus.repo_id and giscus.category and giscus.category_id %}
        <div class="giscus"></div>
        <script id="giscus-script"
                src="https://giscus.app/client.js"
                data-repo="{{ giscus.repo }}"
                data-repo-id="{{ giscus.repo_id }}"
                data-category="{{ giscus.category }}"
                data-category-id="{{ giscus.category_id }}"
                data-mapping="{{ giscus.mapping }}"
                data-strict="{{ giscus.strict }}"
                data-reactions-enabled="{{ giscus.reactions_enabled }}"
                data-emit-metadata="{{ giscus.emit_metadata }}"
                data-input-position="{{ giscus.input_position }}"
                data-theme="{{ giscus.theme_light }}"
                data-lang="{{ giscus.lang }}"
                data-loading="{{ giscus.loading }}"
                crossorigin="anonymous"
                async>
        </script>
        <noscript class="giscus-noscript">Enable JavaScript to view comments powered by Giscus.</noscript>
    {% else %}
        <p class="giscus-placeholder">Comments are coming soon — check back shortly.</p>
    {% endif %}
</section>

<aside class="blog-related">
    <h2>More to explore</h2>
    <ul>
        {% set related = (posts | selectattr('slug', 'ne', post.slug) | list)[:3] %}
        {% if related %}
            {% for other in related %}
                <li>
                    <a href="{{ blog_index_href.replace('index.html', '') }}{{ other.slug }}/">
                        <span class="related-title">{{ other.title }}</span>
                        <span class="related-meta">{{ other.date_display }} • {{ other.reading_time }} min read</span>
                    </a>
                </li>
            {% endfor %}
        {% else %}
            <li>No other posts yet.</li>
        {% endif %}
    </ul>
</aside>
{% endblock %}

{% block scripts %}
    {% if giscus.repo and giscus.repo_id and giscus.category and giscus.category_id %}
        <script>
            (function () {
                const DARK_THEME = '{{ giscus.theme_dark }}';
                const LIGHT_THEME = '{{ giscus.theme_light }}';

                function currentTheme() {
                    const storedTheme = localStorage.getItem('theme');
                    if (storedTheme) {
                        return storedTheme;
                    }
                    return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
                }

                function resolveGiscusTheme(nextTheme) {
                    return nextTheme === 'dark' ? DARK_THEME : LIGHT_THEME;
                }

                function updateGiscusTheme(nextTheme) {
                    const iframe = document.querySelector('iframe.giscus-frame');
                    if (!iframe) {
                        return;
                    }
                    iframe.contentWindow.postMessage({
                        giscus: {
                            setConfig: {
                                theme: resolveGiscusTheme(nextTheme)
                            }
                        }
                    }, 'https://giscus.app');
                }

                document.addEventListener('themechange', function (event) {
                    updateGiscusTheme(event.detail);
                });

                document.addEventListener('DOMContentLoaded', function () {
                    const initialTheme = currentTheme();
                    const giscusScript = document.getElementById('giscus-script');
                    if (giscusScript) {
                        giscusScript.setAttribute('data-theme', resolveGiscusTheme(initialTheme));
                    }

                    const observer = new MutationObserver(function () {
                        const iframe = document.querySelector('iframe.giscus-frame');
                        if (iframe) {
                            updateGiscusTheme(initialTheme);
                            observer.disconnect();
                        }
                    });
                    observer.observe(document.body, { childList: true, subtree: true });
                });
            })();
        </script>
    {% endif %}
{% endblock %}
